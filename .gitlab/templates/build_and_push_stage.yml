.build_and_push_stage_rules: &build_and_push_rules
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "develop"'
      when: always
    - when: never

generate-dynamic-ci:
  stage: build_and_push_stage
  <<: *build_and_push_rules
  image: alpine:latest
  script:
    - apk add --no-cache bash grep sed coreutils
    - chmod +x .gitlab/scripts/generate-docker-ci.sh
    - .gitlab/scripts/generate-docker-ci.sh > docker-ci.yml
  artifacts:
    paths:
      - docker-ci.yml
    expire_in: 1 hour

trigger-docker-jobs:
  stage: build_and_push_stage
  <<: *build_and_push_rules
  trigger:
    include:
      - artifact: docker-ci.yml
        job: generate-dynamic-ci
    strategy: depend
  needs:
    - generate-dynamic-ci
